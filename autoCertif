#!/bin/bash

#              USAGE:
#      chmod +x ./autoCertif
#      sudo ./autoCertif
#      sudo ./autoCertif clean


################## DECLARE FUNCTIONS ######################

checkRoot() {
   if [ $(id -u) -ne 0 ]; then
     printf "Script must be run as root. Try 'sudo ./autoCertif'\n"
     exit 1
   fi
}

checkNeededPackages() {
   lst="expect openssl apache2"
   for items in $lst
   do
     type -P $items &>/dev/null || {
       echo -en "\n Package \"$items\" is not installed!"
       echo -en "\n Install now? y/n: "
       read ops
       case $ops in
           [Yy]* ) sudo apt-get install $items ;;
           	     *)  echo -e "\n Exiting..."
               		break;;
                    #exit 1 ;;
       esac
     }
   done
}

informationCorrect() {
    printf "\n\n"
    echo "Country name = "$countryName
    echo "State or province name = "$stateOrProvinceName
    echo "Locality name = "$localityName
    echo "Organization name = "$organizationName
    echo "Organizational Unit Name = "$organizationUnitName
    echo "Common name = "$server_IP_address
    echo "Email Address = "$email

    while true; do
        printf "\n\n"
        read -p "Are these informations correct ? y/n " yn
        case $yn in
            [Yy]* ) break;;
            [Nn]* ) informationQuerry;;
            * ) echo "Please answer yes or no.";;
        esac
    done
}

informationQuerry() {
    read -p "Country name (2 letter code) = " countryName
    read -p "State or province name (full name) = " stateOrProvinceName
    read -p "Locality name (eg, city) = " localityName
    read -p "Organization name (eg, company) = " organizationName
    read -p "Organizational Unit Name (eg, section) = " organizationUnitName
    read -p "Common Name (e.g. server FQDN or YOUR name) = " server_IP_address
    read -p "Email Address = " email
    read -s -p "PEM pass phrase (4-20 length) =  " PEMpassword
    informationCorrect
}

changeInfo() {
    sed -i 's/dir		= .\/demoCA/dir		= .\/CA/g' CA/ca.cnf
    sed -i 's/countryName_default		= AU/countryName_default		= '$countryName'/g' CA/ca.cnf
    sed -i 's/tateOrProvinceName_default	= Some-State/tateOrProvinceName_default	= '$stateOrProvinceName'/g' CA/ca.cnf
    #sed -i 's/localityName			= Locality Name (eg, city)/localityName			= '$localityName'/g' CA/ca.cnf
    sed -i 's/0.organizationName_default	= Internet Widgits Pty Ltd/0.organizationName_default	= '$organizationName'/g' CA/ca.cnf
    sed -i 's/#organizationalUnitName_default	=/organizationalUnitName_default	= '$organizationUnitName'/g' CA/ca.cnf
    printf "Config file: updated\n"
}

######################## GO ###############################

#checkRoot

if [ "$1" = "clean" ]; then
    rm -R --force CA || sudo rm -R CA
    exit 0;
fi

#checkNeededPackages

mkdir CA && mkdir CA/newcerts && mkdir CA/certrequests && mkdir CA/private
echo "01" > CA/serial && touch CA/index.txt && echo "Architecture: done"
cp openssl.cnf CA/ca.cnf

informationQuerry

changeInfo 

/usr/bin/expect <<EOD
spawn sudo openssl req -new -x509 -extensions v3_ca -newkey rsa:4096 -keyout CA/private/cakey.pem -out CA/cacert.pem -config CA/ca.cnf
expect {Enter PEM pass phrase:} {send "$PEMpassword\n"}
expect {Verifying - Enter PEM pass phrase:} {send "$PEMpassword\n"}
expect -re {Country Name \(2 letter code\) [^:]*:} {send "\n"}
expect -re {State or Province Name \(full name\) [^:]*:} {send "\n"}
expect -re {Locality Name \(eg, city\) [^:]*:} {send "\n"}
expect -re {Organization Name \(eg, company\) [^:]*:} {send "\n"}
expect -re {Organizational Unit Name \(eg, section\) [^:]*:} {send "\n"}
expect -re {Common Name \(e.g. server FQDN or YOUR name\) [^:]*:} {send "${name}\n"}
expect -re {Email Address [^:]*:} {send "\n"}
expect eof
EOD

/usr/bin/expect <<EOD
spawn sudo openssl req -new -nodes -newkey rsa:2048 -keyout CA/private/webserver.key -out CA/certrequests/webserver.csr -config CA/ca.cnf
expect {Enter PEM pass phrase:} {send "$PEMpassword\n"}
expect {Verifying - Enter PEM pass phrase:} {send "$PEMpassword\n"}
expect -re {Country Name \(2 letter code\) [^:]*:} {send "\n"}
expect -re {State or Province Name \(full name\) [^:]*:} {send "\n"}
expect -re {Locality Name \(eg, city\) [^:]*:} {send "\n"}
expect -re {Organization Name \(eg, company\) [^:]*:} {send "\n"}
expect -re {Organizational Unit Name \(eg, section\) [^:]*:} {send "\n"}
expect -re {Common Name \(e.g. server FQDN or YOUR name\) [^:]*:} {send "${name}\n"}
expect -re {Email Address [^:]*:} {send "\n"}
expect eof
EOD


/usr/bin/expect <<EOD
set timeout 20

spawn openssl req -new -x509 -extensions v3_ca -newkey rsa:4096 -keyout CA/private/cakey.pem -out CA/cacert.pem -config CA/ca.cnf

expect "Enter PEM pass phrase:"
send "$PEMpassword\r"

expect "Verifying - Enter PEM pass phrase:"
send "$PEMpassword\r"

expect "Country Name (2 letter code) \[FR\]:"
send ".\r"

expect "State or Province Name (full name) \[$stateOrProvinceName\]:\r"
send ".\r"

expect "$localityName []:\r"
send ".\r"

expect "Organization Name (eg, company) \[$organizationName\]:\r"
send "$organizationName\r"

expect "Organizational Unit Name (eg, section) \[\]:\r"
send "$organizationUnitName\r"

expect "Common Name (e.g. server FQDN or YOUR name) \[\]:\r"
send "$server_IP_address\r"

expect "Email Address \[\]:\r"
send "$email\r"

expect EOF